<!DOCTYPE html>
<html>
	<head>
		<title>Mobile App 1</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

		<link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />

		<script src="kendo/js/jquery.min.js"></script>
		<script src="kendo/js/kendo.all.min.js"></script>

		<link href="styles/main.css" rel="stylesheet" />

	</head>
	<body>

		<!--main view-->
		<div id="main" data-role="view" data-title="Lista de Produtos" data-model="viewModel" data-layout="default">
			<a id="btnAdd" data-role="button" data-icon="add" data-bind="events: { click: addProduct }">Adicionar Produto</a>
			<ul id="products" data-role="listview" data-template="productItem" data-style="inset" data-bind="source: dataSource"></ul>

			<ul id="actions" data-role="actionsheet" data-cancel="Cancelar">
				<li class="km-actionsheet-title">Selecione operação:</li>
				<li>
					<a href="#" data-action="viewModel.showDetails">Detalhes</a>
				</li>
				<li>
					<a href="#" data-action="viewModel.editProduct">Editar</a>
				</li>
				<li>
					<a href="#" data-action="viewModel.destroyProduct">Deletar</a>
				</li>

			</ul>
		</div>

		<!--listview template-->
		<script id="productItem" type="text/x-kendo-template">
			<span>#= ProductName #</span>
			<a class="btnActions"
			   data-role="button"
			   data-rel="actionsheet"
                
			   href="\\#actions"
			   data-actionsheet-context="#= ProductID #">Ações</a>
		</script>

		<!--editor-->
		<div id="editor" data-role="view" data-init="editorViewInit" data-model="viewModel" data-title="Editar produto" data-layout="default">
			<ul id="form" data-role="listview" data-style="inset">
				<li>
					<label>
						Nome do produto:
						<input id="productName" name="ProductName" type="text" required="required" data-bind="value: selectedProduct.ProductName" />
					</label>
				</li>
				<li>
					<label>
						Preço Unitário:
						<input id="unitPrice" name="UnitPrice" type="number" required="required" data-bind="value: selectedProduct.UnitPrice" />
					</label>
				</li>
				<li>
					<label>
						Qtde Estoque:
						<input id="unitsInStock" name="UnitsInStock" type="number" required="required" data-bind="value: selectedProduct.UnitsInStock"/>
					</label>
				</li>
				<li>
					<label>
						Inativo:
						<input id="discontinued" name="Discontinued" type="checkbox" data-bind="value: selectedProduct.Discontinued"/>
					</label>
				</li>
			</ul>
			<a id="btnCreate" data-role="button" type="button" data-bind="events: {click: saveProduct}">Salvar</a>
			<a id="btnCancel" data-role="button" type="button" data-bind="events: {click: cancelChanges}">Cancelar</a>
		</div>

		<!--details view-->
		<div id="details" data-role="view" data-model="viewModel.selectedProduct" data-title="Detalhes" data-layout="default">
			<ul id="info" data-role="listview" data-style="inset">
				<li>
					Nome do Produto: <span data-bind="text: ProductName"></span>
				</li>
				<li>
					Preço Unitário: <span data-bind="text: UnitPrice"></span>
				</li>
				<li>
					Qtde Estoque: <span data-bind="text: UnitsInStock"></span>
				</li>
				<li>
					<label>
						Inativo: <span data-bind="text: Discontinued"></span>
					</label>
				</li>
			</ul>

			<a id="btnBack" data-role="button" href="#:back">Voltar</a>
		</div>

		<!--layout-->
		<div data-role="layout" data-id="default">
			<div data-role="header">
				<div data-role="navbar">
					<span data-role="view-title"></span>
				</div>
			</div>
			<div data-role="footer">
				<!--footer content-->
			</div>
		</div>

		<script type="text/javascript">
			/*
			//add listener when device ready
			document.addEventListener("deviceready", onDeviceReady, false);
			var db = null;

			if (window.sqlitePlugin !== undefined) {
			db = window.sqlitePlugin.openDatabase("MobileMktOne");
			}
			else {
			// For debugin in simulator fallback to native SQL Lite
			console.log("Use built in SQL Lite");
			db = window.openDatabase("MobileMktOne", "1.0", "MobileAppMktOne", 200000);
			}
            
			//function will be called when device ready
			function onDeviceReady() {
			db.transaction(populateDB, errorCB, successCB);
			}

			//create table and insert some record
			function populateDB(tx) {
			tx.executeSql("CREATE TABLE IF NOT EXISTS Products(ProductId INTEGER PRIMARY KEY ASC, ProductName TEXT, UnitPrice REAL, Discontinued INTEGER, UnitsInStock REAL)", []);
			}

			//function will be called when an error occurred
			function errorCB(err) {
			console.log("Error: " + err.message);
			}
			
			//function will be called when process succeed
			function successCB() {
			console.log("Sucesso!");
			db.transaction(queryDB, errorCB);
			}
			
			//select all from SoccerPlayer
			function queryDB(tx) {
			tx.executeSql('SELECT * FROM Products', [], querySuccess, errorCB);
			}
            
			function querySuccess(tx, results) {
			console.log("Returned rows = " + results.rows.length);
			// this will be true since it was a select statement and so rowsAffected was 0
			if (!results.rowsAffected) {
			console.log('No rows affected!');
			return false;
			}
			// for an insert statement, this property will return the ID of the last inserted row
			//console.log("Last inserted row ProductID = " + results.insertId);
			}
			*/
		</script>

		<script type="text/javascript">
            
			var app = new kendo.mobile.Application(document.body),
			validator,
			crudServiceBaseUrl = "http://localhost:50000/api",            
			viewModel = kendo.observable({
				dataSource: new kendo.data.DataSource({
					transport: {
						read:  {
							url: crudServiceBaseUrl + "/Products",							
							type:"GET"      
							,contentType: "application/json"
							,dataType: "json"							
						},
						update: {
							url: crudServiceBaseUrl + "/Products",							
							type:"PUT"
							,contentType: "application/json"
							,dataType: "json"
						},
						destroy: {
			
							url: crudServiceBaseUrl + "/Products"                            
							,type:"DELETE"
							,contentType: "application/json"   
							,dataType: "json"
						},
						create: {
							url: crudServiceBaseUrl + "/Products"													
							,type:"POST"                            
							,contentType: "application/json"
							,dataType: "json" 
						},
						parameterMap: function(data, operation) {
							if (operation !== "read" && data.models) {
								return kendo.stringify([data.models[0]]);
							}
						}
					},
					batch: true,
					//pageSize: 5,
					schema: { 
						model: {
							id: "ProductID",
							fields: {
								ProductId: { editable: false, nullable: true },
								ProductName: { validation: { required: true} },
								UnitPrice: { type: "number", validation: { required: true, min: 1, max: 999} },
								Discontinued: { type: "boolean" },
								UnitsInStock: { type: "number", validation: { min: 0, required: true} }
							} 
						}
					}
				}),
				addProduct: function() {
					var newProduct = this.dataSource.add(); //adds a new data item to the DataSource
					this.set("selectedProduct", newProduct); //sets the selected product
					app.navigate("#editor"); //navigates to editor view
				},
				selectedProduct: {},
				saveProduct: function() {
					if (validator.validate()) { //validates the input
						this.dataSource.sync(); //synchronizes changes through the transport
						app.navigate("#main"); //navigates to main view
					}
				},
				cancelChanges: function() {
					this.dataSource.cancelChanges(); //cancels the changes made to the DataSource after the last sync
					app.navigate("#main"); //navigates to main view
				},
				editProduct: function(e) {
					var product = viewModel.dataSource.get(e.context); //gets the ActionSheet context
					viewModel.set("selectedProduct", product);  //sets the selected product
					app.navigate("#editor"); //navigates to editor view
				},
				destroyProduct: function(e) {
					var product = viewModel.dataSource.get(e.context); //gets the ActionSheet context
					viewModel.dataSource.remove(product); //removes the product from the DataSource
					viewModel.dataSource.sync(); //synchronizes changes through the transport
				},
				showDetails: function(e) {
					var product = viewModel.dataSource.get(e.context); //gets the ActionSheet context
					viewModel.set("selectedProduct", product); //sets the selected product
					app.navigate("#details"); //navigates to details view
				}
			});
			
			function editorViewInit(e) {
				validator = $("#form").kendoValidator({ //initialize the validator
					messages: {
						required: function(input) { //create a custom message function
							input.attr("placeholder", input.attr("name") + " is required");
						}
					}
				}).data("kendoValidator");
			}
			
		</script>

		<script type="text/javascript" charset="utf-8" src="Plugins/SQLite/SQLitePlugin.js"></script>
		<script type="text/javascript" charset="utf-8" src="scripts/LocalStorage.js"></script>

	</body>

</html>

